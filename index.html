<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>WindowsよりMacよりLinuxがいい</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="WindowsよりMacよりLinuxがいい">
<meta property="og:url" content="https://harre-orz.github.io/index.html">
<meta property="og:site_name" content="WindowsよりMacよりLinuxがいい">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="harre.orz">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="WindowsよりMacよりLinuxがいい" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">WindowsよりMacよりLinuxがいい</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://harre-orz.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-20200822-sshpiper" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/22/20200822-sshpiper/" class="article-date">
  <time datetime="2020-08-21T15:00:00.000Z" itemprop="datePublished">2020-08-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/22/20200822-sshpiper/">SSHをプロキシするsshpiperの紹介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="sect1">
<h2 id="_sshpiper_とは">sshpiper とは</h2>
<div class="sectionbody">
<div class="paragraph">
<p>sshpiper は <a href="https://github.com/tg123/sshpiper" target="_blank" rel="noopener" class="bare">https://github.com/tg123/sshpiper</a> が開発しているSSLプロキシサーバです。SSHのユーザ名をキーにして別のSSHホストにプロキシすることができます。</p>
</div>
<div class="paragraph">
<p>最近のクラウド・仮想化によりサーバが直接インターネットに接続していない場合に有効そうだったので確認しました。
なお、インストール方法は、GitHub に丁寧に記載されていますので割愛します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_動作について">動作について</h2>
<div class="sectionbody">
<div class="paragraph">
<p>sshpiper 自身にはパスワード認証はなく、プロキシ先のサーバが存在してパスワード要求している場合にパスワード要求をプロキシします。
ただし、公開鍵暗号方式を利用する場合は、接続元ホストの公開鍵を sshpiper に設定し、sshpiper の秘密鍵を プロキシ先のホストに設定する必要があります。</p>
</div>
<div class="paragraph">
<p>ポートフォワーディングなどもプロキシするので、SSHを踏み台する場合だと複雑な工程になる省略することもできます。</p>
</div>
</div>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2020/08/22/20200822-sshpiper/" data-id="cke4jom9j0000wzl2djmy0ufw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200222-lxc-centos" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/22/20200222-lxc-centos/" class="article-date">
  <time datetime="2020-02-21T15:00:00.000Z" itemprop="datePublished">2020-02-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/22/20200222-lxc-centos/">CentOS7のLXCでCentOS6を非特権ユーザで起動させる</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="sect1">
<h2 id="_はじめに">はじめに</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この記事は、とある調査の結果をまとめたものであって、一般には参考にならない内容になっているのでご注意ください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_centos_7で特権ユーザ">CentOS 7で特権ユーザ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CentOS 7の epel に含まれる lxc 1.0.11 では、非特権機能がまともに動きません。素直に lxc-3.0.x の最新安定版のソースコードを公式からダウンロードしてビルド <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> します。</p>
</div>
<div class="paragraph">
<p>bridge の設定をします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># yum install bridge-utils
# brctl addbr lxcbr0</pre>
</div>
</div>
<div class="paragraph">
<p>非特権ユーザの設定をします。</p>
</div>
<div class="listingblock">
<div class="title">/etc/subuid</div>
<div class="content">
<pre>root:100000:65536</pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/subgid</div>
<div class="content">
<pre>root:100000:65536</pre>
</div>
</div>
<div class="listingblock">
<div class="title">/etc/lxc/lxc-usernet</div>
<div class="content">
<pre>root veth lxcbr0 10</pre>
</div>
</div>
<div class="paragraph">
<p>CentOS 6は、initプロセスが大きく違うので、手始めに CentOS 7 のコンテナを作成して特権ユーザで起動できることを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># lxc-create -n centos7 -t centos -- -R 7

# lxc-ls -f
NAME      STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED
centos7   STOPPED 0         -      -    -    false</pre>
</div>
</div>
<div class="paragraph">
<p>起動しようとすると、以下の <code>No space left on device</code> というエラーになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># lxc-start -n centos7 -F
lxc-start: centos7: cgroups/cgfsng.c: __do_cgroup_enter: 1498 No space left on device - Failed to enter cgroup "/sys/fs/cgroup/cpuset//lxc.monitor/centos7/cgroup.procs"
lxc-start: centos7: start.c: __lxc_start: 1992 Failed to enter monitor cgroup
lxc-start: centos7: tools/lxc_start.c: main: 329 The container failed to start
lxc-start: centos7: tools/lxc_start.c: main: 335 Additional information can be obtained by setting the --logfile and --logpriority options</pre>
</div>
</div>
<div class="paragraph">
<p>/sys/fs/cgroup の容量は十分に空いています。原因を調べたところ以下のフラグを 1 にする必要がありました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>echo 1 &gt;&gt; `/sys/fs/cgroup/cpuset/cgroup.clone_children`</pre>
</div>
</div>
<div class="paragraph">
<p>ただし、必ず lxc-start を実行する前に指定しなければいけません。もし、１度でも lxc-start でコンテナを起動してしまった場合、cgroup が不完全な状態で作成されてしまうので二度と起動 <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> できなくなります。</p>
</div>
<div class="paragraph">
<p>事実、２回目以降はエラーは以下のように <code>File exists</code> なります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>lxc-start: centos7: cgroups/cgfsng.c: mkdir_eexist_on_last: 1277 File exists - Failed to create directory "/sys/fs/cgroup/cpuset//lxc.monitor/centos7"
lxc-start: centos7: cgroups/cgfsng.c: monitor_create_path_for_hierarchy: 1298 Failed to create cgroup "/sys/fs/cgroup/cpuset//lxc.monitor/centos7"
lxc-start: centos7: cgroups/cgfsng.c: cgfsng_monitor_create: 1388 Failed to create cgroup "/sys/fs/cgroup/cpuset//lxc.monitor/centos7"
lxc-start: centos7: cgroups/cgfsng.c: __do_cgroup_enter: 1498 No space left on device - Failed to enter cgroup "/sys/fs/cgroup/cpuset//lxc.monitor/centos7-1/cgroup.procs"
lxc-start: centos7: start.c: __lxc_start: 1992 Failed to enter monitor cgroup
lxc-start: centos7: tools/lxc_start.c: main: 329 The container failed to start
lxc-start: centos7: tools/lxc_start.c: main: 335 Additional information can be obtained by setting the --logfile and --logpriority options</pre>
</div>
</div>
<div class="paragraph">
<p>これで CentOS 7 が起動できました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># brctl addbr lxcbr0
# echo 1 &gt;&gt; `/sys/fs/cgroup/cpuset/cgroup.clone_children`

# lxc-start --name centos7 -F
lxc-start: centos7: start.c: proc_pidfd_open: 1607 Function not implemented - Failed to send signal through pidfd
systemd 219 running in system mode. (+PAM +AUDIT +SELINUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 -SECCOMP +BLKID +ELFUTILS +KMOD +IDN)
Detected virtualization lxc.
Detected architecture x86-64.

Welcome to CentOS Linux 7 (Core)!</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_centos_7で非特権ユーザ">CentOS 7で非特権ユーザ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>コンテナが特権か非特権か？は、 lxc-ls コマンド結果の <code>UNPRIVILEGED</code> で確認することができます。
現在は <code>false</code> となっており特権ユーザであることを表しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># lxc-ls -f
NAME      STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED
centos7   STOPPED 0         -      -    -    false</pre>
</div>
</div>
<div class="paragraph">
<p>非特権ユーザにするには、コンテナの設定ファイルに以下の2行を追記します。</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/var/lib/lxc/centos7/config</div>
<div class="content">
<pre>lxc.idmap = u 0 100000 65536
lxc.idmap = g 0 100000 65536</pre>
</div>
</div>
<div class="paragraph">
<p>設定が正しければ <code>UNPRIVILEGED</code> が <code>true</code> に変わります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># lxc-ls -f
NAME      STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED
centos7   STOPPED 0         -      -    -    false</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
コンテナが起動中の場合は <code>true</code> になりません。一度コンテナを停止させます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>起動しようとすると、以下の <code>Failed to clone process in new user namespace</code> というエラーになります。
原因は、CentOS 7 の現在の最新のカーネル 3.10.0-1062.12.1.el7.x86_64 では、非特権ユーザに対応していないためです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># lxc-start -n centos7
lxc-start: centos7: cgroups/cgfsng.c: mkdir_eexist_on_last: 1277 File exists - Failed to create directory "/sys/fs/cgroup/systemd//lxc.payload/centos7"
lxc-start: centos7: cgroups/cgfsng.c: container_create_path_for_hierarchy: 1317 Failed to create cgroup "/sys/fs/cgroup/systemd//lxc.payload/centos7"
lxc-start: centos7: cgroups/cgfsng.c: cgfsng_payload_create: 1454 Failed to create cgroup "/sys/fs/cgroup/systemd//lxc.payload/centos7"
lxc-start: centos7: start.c: lxc_spawn: 1737 Invalid argument - Failed to clone a new set of namespaces
lxc-start: centos7: start.c: __lxc_start: 2019 Failed to spawn container "centos7"
lxc-start: centos7: conf.c: userns_exec_1: 4311 Failed to clone process in new user namespace
lxc-start: centos7: tools/lxc_start.c: main: 329 The container failed to start
lxc-start: centos7: tools/lxc_start.c: main: 335 Additional information can be obtained by setting the --logfile and --logpriority options</pre>
</div>
</div>
<div class="paragraph">
<p>そのため、カーネルを 3.12 以上に上げます。CentOS 7には、都合のいいバージョンは落ちていないため elrepo で最新のカーネルをインストールします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
# rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
# yum install --enablerepo=elrepo-kernel kernel-ml</pre>
</div>
</div>
<div class="paragraph">
<p>僕の場合は 5.5.5-1 が落ちてきたので、OS再起動してカーネルを変更してからもう一度コンテナを起動させます。
しかし、rootfs が <code>Permission denied</code> となり、まだ起動できません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># uname -r
5.5.5-1.el7.elrepo.x86_64

# brctl addbr lxcbr0
# echo 1 &gt;&gt; `/sys/fs/cgroup/cpuset/cgroup.clone_children`

# lxc-start --name centos7 -F
lxc-start: centos7: storage/dir.c: dir_mount: 198 Permission denied - Failed to mount "/usr/local/var/lib/lxc/centos7/rootfs" on "/usr/local/lib/lxc/rootfs"
lxc-start: centos7: conf.c: lxc_mount_rootfs: 1328 Failed to mount rootfs "/usr/local/var/lib/lxc/centos7/rootfs" onto "/usr/local/lib/lxc/rootfs" with options "(null)"
lxc-start: centos7: conf.c: lxc_setup_rootfs_prepare_root: 3393 Failed to setup rootfs for
lxc-start: centos7: conf.c: lxc_setup: 3496 Failed to setup rootfs
lxc-start: centos7: start.c: do_start: 1299 Failed to setup container "centos7"
lxc-start: centos7: sync.c: __sync_wait: 62 An error occurred in another process (expected sequence number 5)
lxc-start: centos7: start.c: lxc_abort: 1103 Function not implemented - Failed to send SIGKILL to 2809
lxc-start: centos7: start.c: __lxc_start: 2019 Failed to spawn container "centos7"
lxc-start: centos7: tools/lxc_start.c: main: 329 The container failed to start
lxc-start: centos7: tools/lxc_start.c: main: 335 Additional information can be obtained by setting the --logfile and --logpriority options</pre>
</div>
</div>
<div class="paragraph">
<p>rootfs の上位ディレクトリの権限を変更して、他人でも閲覧できるようにします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># ls -ld /usr/local/var/lib/lxc/centos7
drwxrwx--- 3 root root 55 Feb 22 20:48 /usr/local/var/lib/lxc/centos7

# chmod 775 /usr/local/var/lib/lxc/centos7

# ls -ld /usr/local/var/lib/lxc/centos7
drwxrwxr-x 3 root root 55 Feb 22 20:48 /usr/local/var/lib/lxc/centos7</pre>
</div>
</div>
<div class="paragraph">
<p>これで CentOS 7 が非特権ユーザで起動できました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># lxc-start --name centos7 -F
lxc-start: centos7: start.c: proc_pidfd_open: 1607 Function not implemented - Failed to send signal through pidfd
systemd 219 running in system mode. (+PAM +AUDIT +SELINUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 -SECCOMP +BLKID +ELFUTILS +KMOD +IDN)
Detected virtualization lxc.
Detected architecture x86-64.

Welcome to CentOS Linux 7 (Core)!</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_centos_6で非特権ユーザ">CentOS 6で非特権ユーザ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CentOS 6のコンテナを作成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># lxc-create -n centos6 -t centos -- -R 6</pre>
</div>
</div>
<div class="paragraph">
<p>まだ、特権ユーザであるため lxc.idmap の設定を追記します。</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/var/lib/lxc/centos6/config</div>
<div class="content">
<pre>lxc.idmap = u 0 100000 65536
lxc.idmap = g 0 100000 65536</pre>
</div>
</div>
<div class="paragraph">
<p>非特権ユーザにできたので、起動してみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># chmod 755 /usr/local/var/lib/lxc/centos6

# lxc-ls -f
NAME      STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED
centos6   STOPPED 0         -      -    -    true
centos7   RUNNING 0         -      -    -    true

# lxc-start --name centos6 -F
init: lxc-sysinit pre-start process (2) terminated with status 1
cat: /proc/self/attr/current: Invalid argument
                Welcome to CentOS</pre>
</div>
</div>
<div class="paragraph">
<p>起動はできましたが、途中で止まってしまいます。init.d の時代は 非root で実行することを考慮していないためです。</p>
</div>
<div class="paragraph">
<p>とりあえず、起動スクリプトをすべて止めます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># chroot /usr/local/var/lib/lxc/centos6/rootfs/

# chkconfig --list
crond           0:off   1:off   2:on    3:on    4:on    5:on    6:off
iptables        0:off   1:off   2:on    3:on    4:on    5:on    6:off
netconsole      0:off   1:off   2:off   3:off   4:off   5:off   6:off
netfs           0:off   1:off   2:off   3:on    4:on    5:on    6:off
network         0:off   1:off   2:on    3:on    4:on    5:on    6:off
rdisc           0:off   1:off   2:off   3:off   4:off   5:off   6:off
restorecond     0:off   1:off   2:off   3:off   4:off   5:off   6:off
rsyslog         0:off   1:off   2:on    3:on    4:on    5:on    6:off
saslauthd       0:off   1:off   2:off   3:off   4:off   5:off   6:off
sendmail        0:off   1:off   2:on    3:on    4:on    5:on    6:off
sshd            0:off   1:off   2:on    3:on    4:on    5:on    6:off
udev-post       0:off   1:on    2:off   3:off   4:off   5:off   6:off

# chkconfig crond off
# chkconfig iptables off
# chkconfig netfs off
# chkconfig network off
# chkconfig rsyslog off
# chkconfig sendmail off
# chkconfig sshd off

# echo &gt; /etc/rc.d/rc.sysinit</pre>
</div>
</div>
<div class="paragraph">
<p>不要な /dev/tty も消しておきます。これをやっておかないと1コンテナあたり無駄なプロセスが 6 個も起動してしまいます。</p>
</div>
<div class="listingblock">
<div class="title">/etc/sysconfig/init</div>
<div class="content">
<pre>ACTIVE_CONSOLES=/dev/tty[1-6]
↓
ACTIVE_CONSOLES=</pre>
</div>
</div>
<div class="paragraph">
<p>また /etc/mtab も作成する必要があります。自分で書くのが面倒だったので、特権ユーザで起動させて rc.sysinit で生成したものを利用しました。</p>
</div>
<div class="listingblock">
<div class="title">/etc/mtab</div>
<div class="content">
<pre># cat /etc/mtab
sysfs /sys sysfs rw,nosuid,nodev,noexec,relatime 0 0
proc /proc proc rw,nosuid,nodev,noexec,relatime 0 0
devtmpfs /dev devtmpfs rw,nosuid,size=474792k,nr_inodes=118698,mode=755 0 0
securityfs /sys/kernel/security securityfs rw,nosuid,nodev,noexec,relatime 0 0
tmpfs /dev/shm tmpfs rw,nosuid,nodev 0 0
devpts /dev/pts devpts rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000 0 0
tmpfs /run tmpfs rw,nosuid,nodev,mode=755 0 0
tmpfs /sys/fs/cgroup tmpfs ro,nosuid,nodev,noexec,mode=755 0 0
cgroup /sys/fs/cgroup/systemd cgroup rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd 0 0
pstore /sys/fs/pstore pstore rw,nosuid,nodev,noexec,relatime 0 0
cgroup /sys/fs/cgroup/memory cgroup rw,nosuid,nodev,noexec,relatime,memory 0 0
cgroup /sys/fs/cgroup/blkio cgroup rw,nosuid,nodev,noexec,relatime,blkio 0 0
cgroup /sys/fs/cgroup/net_cls,net_prio cgroup rw,nosuid,nodev,noexec,relatime,net_cls,net_prio 0 0
cgroup /sys/fs/cgroup/freezer cgroup rw,nosuid,nodev,noexec,relatime,freezer 0 0
cgroup /sys/fs/cgroup/pids cgroup rw,nosuid,nodev,noexec,relatime,pids 0 0
cgroup /sys/fs/cgroup/cpuset cgroup rw,nosuid,nodev,noexec,relatime,cpuset,clone_children 0 0
cgroup /sys/fs/cgroup/cpu,cpuacct cgroup rw,nosuid,nodev,noexec,relatime,cpu,cpuacct 0 0
cgroup /sys/fs/cgroup/rdma cgroup rw,nosuid,nodev,noexec,relatime,rdma 0 0
cgroup /sys/fs/cgroup/hugetlb cgroup rw,nosuid,nodev,noexec,relatime,hugetlb 0 0
cgroup /sys/fs/cgroup/perf_event cgroup rw,nosuid,nodev,noexec,relatime,perf_event 0 0
cgroup /sys/fs/cgroup/devices cgroup rw,nosuid,nodev,noexec,relatime,devices 0 0
configfs /sys/kernel/config configfs rw,relatime 0 0
/dev/mapper/centos-root / xfs rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota 0 0
systemd-1 /proc/sys/fs/binfmt_misc autofs rw,relatime,fd=26,pgrp=1,timeout=0,minproto=5,maxproto=5,direct,pipe_ino=19458 0 0
debugfs /sys/kernel/debug debugfs rw,relatime 0 0
hugetlbfs /dev/hugepages hugetlbfs rw,relatime,pagesize=2M 0 0
mqueue /dev/mqueue mqueue rw,relatime 0 0
/dev/sda1 /boot xfs rw,relatime,attr2,inode64,logbufs=8,logbsize=32k,noquota 0 0
tmpfs /run/user/1000 tmpfs rw,nosuid,nodev,relatime,size=97784k,mode=700,uid=1000,gid=1000 0 0</pre>
</div>
</div>
<div class="paragraph">
<p>これで CentOS 6 が非特権ユーザで起動できました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># lxc-start --name centos6</pre>
</div>
</div>
<div class="paragraph">
<p>お疲れ様でした。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_補足">補足</h2>
<div class="sectionbody">
<div class="paragraph">
<p>検証している中で LXC の動作が途中で失敗すると <code>/sys/fs/cgroup</code> にコンテナのゴミが残り再起動できなくなる問題が度々発生しました。Cgroups を操作すれば消すことはできると思うのですが調べていません。</p>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. LXC は Canonical社が支援しているだけあり RPM はありません。
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. OS再起動で直ります
</div>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2020/02/22/20200222-lxc-centos/" data-id="cke4hlcu3000dndl22rrfcuzl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS-6/" rel="tag">CentOS 6</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS-7/" rel="tag">CentOS 7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LXC/" rel="tag">LXC</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200221-lvm-mysql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/21/20200221-lvm-mysql/" class="article-date">
  <time datetime="2020-02-20T15:00:00.000Z" itemprop="datePublished">2020-02-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/21/20200221-lvm-mysql/">MySQLのデータベースごとにディスク容量制限を簡単にしたい</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="sect1">
<h2 id="_モチベーション">モチベーション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MySQLのデータベース単位で quota のようなディスク容量制限をしたかったのですが、MySQL にはそういった機能がないようでした。
しかし、MySQL はデータベースごとにフォルダが別れているので、各フォルダごとにディスクをマウントすれば容量の制限ができると思い、
LVM で小さな領域を作成して、データベースのフォルダ位置にマウントしてみたところ、制限ができたのでこの方法を採用しました。</p>
</div>
<div class="paragraph">
<p>データベースを作成する度に、すべて手作業で実施していたらいつかはLVMの操作ミスでデータが喪失する恐れがありました。
また、レプリカしているDBの場合にレプリカ先にも同じマウントポイントを指定する必要があり、作業が漏れやすいという問題もありました。
そのため ansible のプレイブックを使って、すべての作業を 1コマンド で実行できるようにしました。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_プレイブック">プレイブック</h2>
<div class="sectionbody">
<div class="paragraph">
<p>最新の ansible には、parted コマンド、LVM操作コマンド、mkfs系コマンド、mysql操作コマンドが用意されているので、これらを組み合わせた以下のプレイブックを作成します。</p>
</div>
<div class="listingblock">
<div class="title">task.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml"><pre><code class="highlight yaml"><span class="meta">---</span>
<span class="comment"># parted で 基本パーティション 1 を作成する</span>
<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">partition</span>
  <span class="attr">parted:</span>
    <span class="attr">device:</span> <span class="string">"{{ item }}"</span>
    <span class="attr">number:</span> <span class="number">1</span>
    <span class="attr">state:</span> <span class="string">present</span>
    <span class="attr">flags:</span> <span class="string">[</span> <span class="string">lvm</span> <span class="string">]</span>
  <span class="attr">with_items:</span> <span class="string">"{{ userctl_disks }}"</span>

<span class="comment"># 物理ボリュームとボリュームグループを作成する</span>
<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">physical</span> <span class="string">volume</span> <span class="string">and</span> <span class="string">volume</span> <span class="string">group</span>
  <span class="attr">lvg:</span>
    <span class="attr">vg:</span> <span class="string">rdb</span>
    <span class="attr">pvs:</span> <span class="string">"{{ userctl_disks | map('regex_replace', '$', '1') | list }}"</span>

<span class="comment"># 論理ボリュームを作成する</span>
<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">logical</span> <span class="string">volume</span>
  <span class="attr">lvol:</span>
    <span class="attr">vg:</span> <span class="string">rdb</span>
    <span class="attr">lv:</span> <span class="string">"{{ item.db_name }}"</span>
    <span class="attr">size:</span> <span class="string">"{{ item.db_size }}"</span>
  <span class="attr">with_items:</span> <span class="string">"{{ userctl_users }}"</span>

<span class="comment"># XFSでフォーマットする</span>
<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">format</span> <span class="string">for</span> <span class="string">xfs</span>
  <span class="attr">filesystem:</span>
    <span class="attr">dev:</span> <span class="string">"/dev/rdb/{{ item.db_name }}"</span>
    <span class="attr">fstype:</span> <span class="string">xfs</span>
    <span class="attr">resizefs:</span> <span class="literal">yes</span>
  <span class="attr">with_items:</span> <span class="string">"{{ userctl_users }}"</span>

<span class="comment"># マウントポイントを設定する</span>
<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mount</span> <span class="string">point</span>
  <span class="attr">mount:</span>
    <span class="attr">src:</span> <span class="string">"/dev/rdb/{{ item.db_name }}"</span>
    <span class="attr">path:</span> <span class="string">"/var/lib/mysql/{{ item.db_name }}"</span>
    <span class="attr">fstype:</span> <span class="string">xfs</span>
    <span class="attr">opts:</span> <span class="string">'defaults,discard'</span>
    <span class="attr">state:</span> <span class="string">mounted</span>
  <span class="attr">with_items:</span> <span class="string">"{{ userctl_users }}"</span>

<span class="comment"># マウントポイントの権限を変更する</span>
<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">change</span> <span class="string">owner</span> <span class="string">and</span> <span class="string">permission</span>
  <span class="attr">file:</span>
    <span class="attr">path:</span> <span class="string">"/var/lib/mysql/{{ item.db_name }}"</span>
    <span class="attr">state:</span> <span class="string">directory</span>
    <span class="attr">owner:</span> <span class="string">mysql</span>
    <span class="attr">group:</span> <span class="string">mysql</span>
    <span class="attr">mode:</span> <span class="string">'0700'</span>
  <span class="attr">with_items:</span> <span class="string">"{{ userctl_users }}"</span>

<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">pymysql</span>
  <span class="attr">pip:</span>
    <span class="attr">name:</span> <span class="string">pymysql</span>

<span class="comment"># データベースを作成する</span>
<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span> <span class="string">create</span> <span class="string">db</span>
  <span class="attr">mysql_db:</span>
    <span class="attr">login_user:</span> <span class="string">root</span>
    <span class="attr">name:</span> <span class="string">"{{ item.db_name }}"</span>
  <span class="attr">with_items:</span> <span class="string">"{{ userctl_users }}"</span>

<span class="comment"># データベースユーザを作成して、権限を指定する</span>
<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span> <span class="string">create</span> <span class="string">user</span>
  <span class="attr">mysql_user:</span>
    <span class="attr">login_user:</span> <span class="string">root</span>
    <span class="attr">name:</span> <span class="string">"{{ item.db_user }}"</span>
    <span class="attr">host:</span> <span class="string">"{{ item.db_host | default('localhost') }}"</span>
    <span class="attr">password:</span> <span class="string">"{{ item.db_pass }}"</span>
    <span class="attr">priv:</span> <span class="string">"{{ item.db_name }}.*:{{ item.db_priv | default('ALL') }}"</span>
    <span class="attr">state:</span> <span class="string">"{{ item.db_state | default('present') }}"</span>
  <span class="attr">with_items:</span> <span class="string">"{{ userctl_users }}"</span></code></pre></code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、実行するための変数を定義した以下のプレイブックを作成します。</p>
</div>
<div class="listingblock">
<div class="title">main.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml"><pre><code class="highlight yaml"><span class="meta">---</span>
<span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">localhost</span>
  <span class="attr">become:</span> <span class="literal">yes</span>
  <span class="attr">vars:</span>
    <span class="comment"># 物理ディスク</span>
    <span class="attr">userctl_disks:</span>
    <span class="bullet">-</span> <span class="string">/dev/sdb</span>
    <span class="comment">#- /dev/sdc</span>
    <span class="comment">#- /dev/sdd</span>

    <span class="comment"># ユーザ用データベース領域</span>
    <span class="comment"># - db_name: データベース名は使用できない文字が多いので注意</span>
    <span class="comment">#   db_host: 接続許可するIPアドレス(ホスト名)。省略すると 'localhost' になる</span>
    <span class="comment">#   db_user: ユーザ名は使用できない文字が多いので注意</span>
    <span class="comment">#   db_pass: パスワード</span>
    <span class="comment">#   db_size: '1G' とか '256M' とか</span>
    <span class="comment">#   db_priv: 'ALL' とか 'SELECT' とか。省略すると 'ALL' になる</span>
    <span class="comment">#   db_state: 'absent' を書くとアカウントが無効になる。※データは消えない</span>
    <span class="attr">userctl_users:</span>
    <span class="bullet">-</span> <span class="attr">db_name:</span> <span class="string">miku</span>
      <span class="attr">db_host:</span> <span class="string">'%'</span>
      <span class="attr">db_user:</span> <span class="string">'hatsune-miku'</span>
      <span class="attr">db_pass:</span> <span class="string">secret</span>
      <span class="attr">db_size:</span> <span class="string">32M</span>
      <span class="attr">db_priv:</span> <span class="string">'ALL'</span>

  <span class="attr">tasks:</span>
  <span class="bullet">-</span> <span class="attr">include:</span> <span class="string">"task.yml"</span></code></pre></code></pre>
</div>
</div>
<div class="paragraph">
<p>今後は、このプレイブックの変数に、追加・編集して ansible-playbook を実行するだけになったので、作業が簡単になりました。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_注意事項">注意事項</h2>
<div class="sectionbody">
<div class="paragraph">
<p>なお、LVMを使っての容量制限は。詳細まで検証しているわけではないです。最悪の場合データベースを破壊してしまうかもしれません。
この方法について、ご指摘がある方はコメントでお知らせください。</p>
</div>
</div>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2020/02/21/20200221-lvm-mysql/" data-id="cke4hlcu5000fndl2c0w8atwc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ansible/" rel="tag">Ansible</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LVM/" rel="tag">LVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200218-rsync" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/18/20200218-rsync/" class="article-date">
  <time datetime="2020-02-17T15:00:00.000Z" itemprop="datePublished">2020-02-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/18/20200218-rsync/">大量のデータをrsyncで転送できない問題とその解決策</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="sect1">
<h2 id="_問題">問題</h2>
<div class="sectionbody">
<div class="paragraph">
<p>あるシステムで、大量のデータをrsync+ssh をデータを転送しようとするが、うまくできない問題が発生しました。
sshの接続性やrsyncの動作は問題ないことを確認済みで、データ量が多くなることに起因していると思われるので調査しました。</p>
</div>
<div class="paragraph">
<p>また、rsync の出力結果をみると <code>sending incremental file list</code> の１行だけが出力されていて、それ以降の出力がないためrsync処理中に中断しているような感じでした。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_原因と解決策">原因と解決策</h2>
<div class="sectionbody">
<div class="paragraph">
<p>原因は、単純で rsync のデータ転送の計算に時間がかかり過ぎたことにより、データ無転送の状態がしばらく続き ssh のコネクションが切れてしまったからでした。
そのため、サーバ側で ClientAliveInterval を指定するか クライアント側で ServerAliveInterval を指定することで解決ができます。
なお、サーバ側とクライアント側のどちらか片方の設定で十分です、両方にキープアライブ設定を入れても効果は変わりません。</p>
</div>
<div class="paragraph">
<p>サーバ側で指定する場合は、以下のように設定変更をします。</p>
</div>
<div class="listingblock">
<div class="title">/etc/ssh/sshd_config</div>
<div class="content">
<pre>#ClientAliveInterval 0
ClientAliveInterval 60</pre>
</div>
</div>
<div class="paragraph">
<p>クライアント側で指定する場合は、rsync の -e オプションで指定するのが簡単です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ rsync -e 'ssh -o ServerAliveInterval=60' ...</pre>
</div>
</div>
<div class="paragraph">
<p>この手の問題は、普通に rsync する程度では発生せずデータが多くなることで発生するため、発生を予測してキープアライブ設定をする対応は難しいと思っています。
そのため、rsync に失敗しても気づけるような仕組みを導入したほうがいいでしょう。</p>
</div>
</div>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2020/02/18/20200218-rsync/" data-id="cke4hlcua000indl22h954cyu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rsync/" rel="tag">rsync</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200215-hexo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/16/20200215-hexo/" class="article-date">
  <time datetime="2020-02-15T15:00:00.000Z" itemprop="datePublished">2020-02-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/16/20200215-hexo/">静的サイトジェネレータをPelicanからHexoに切り替えた</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="sect1">
<h2 id="_背景">背景</h2>
<div class="sectionbody">
<div class="paragraph">
<p>pelicanを採用した理由は python で書かれており、何か問題があってもトラブルシュートができるからでした。
実際、AsciiDocのプラグインが文字化けしたり正常に機能しないことが多々あり、自分の環境で動くように調整する必要がありました。</p>
</div>
<div class="paragraph">
<p>また、GitHub Pages のブロクを書いていて、コメントができないのは不便だなーと思いつつ、何も調べないまま Pelican を採用したのも失敗でした。
Pelican でも Disqus であれば、JS埋め込みで対応できるようですが、あまり標準で対応している感じではありませんでした。</p>
</div>
<div class="paragraph">
<p>そのため、Pelican をやめて Hexo に切り替えることにしました。</p>
</div>
<div class="paragraph">
<p>Hexo は nodejs で書かれており、npm でプラグインをインストールすることで様々な機能に対応することができます。
もちろん AsciiDoc にも対応したプラグインもあります。</p>
</div>
<div class="paragraph">
<p>僕は、以下のプラグインを入れています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hexo-cli</p>
</li>
<li>
<p>hexo-renderer-asciidoc</p>
</li>
<li>
<p>hexo-plugin-gitalk</p>
</li>
<li>
<p>hexo-deployer-git</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hexo_環境整備">Hexo 環境整備</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_インストール">インストール</h3>
<div class="listingblock">
<div class="title">自分用のメモ</div>
<div class="content">
<pre>// Arch Linux の場合は pacman で npm をインストール
$ sudo pacman -S npm

// hexo-cli をインストール
$ sudo npm install hexo-cli -g

// サイトのプロジェクトフォルダを作成
$ hexo init harre-orz.github.io
$ cd harre-orz.github.io

// 依存パッケージをインストール
$ npm install

// AsciiDoc をインストール
$ npm install hexo-renderer-asciidoc --save

// gitalk コメントを使うためにをインストール
$ npm install hexo-plugin-gitalk --save

// Github Pages にデプロイするためのプラグインをインストール
$ npm install hexo-deployer-git --save

// git の初期化
$ git init
$ git remote add origin git@github.com:harre-orz/harre-orz.github.io.git

// deploy
$ hexo deploy -g</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_landscape_の編集">landscape の編集</h3>
<div class="paragraph">
<p>標準で用意されているテーマ`landscape`の出来はいいのですが、AsciiDoc が生成するコードと相性が悪いようで、CSSの修正が必要でした。</p>
</div>
<div class="listingblock">
<div class="title">themes/landscape/source/css/_partial/highlight.styl</div>
<div class="content">
<pre class="highlight"><code class="language-css" data-lang="css"><pre><code class="highlight css">link:themes/landscape/source/css/_partial/highlight.styl[]</code></pre></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_asciidoc_の編集">asciidoc の編集</h3>
<div class="paragraph">
<p>asciidoc もそのままでは セキュリティレベルが高く <code>include</code> が利用できません。レンダリングオプションに <code>&#123; safe: "safe" &#125;</code> を指定します。</p>
</div>
<div class="listingblock">
<div class="title">node_modules/hexo-renderer-asciidoc/lib/renderer.js</div>
<div class="content">
<pre>link:node_modules/hexo-renderer-asciidoc/lib/renderer.js[]</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gitalk_の編集">gitalk の編集</h3>
<div class="paragraph">
<p><code>gitalk</code> も、標準の場合はトップページに先頭の記事の中にコメント枠が表示され、それがトップページ用のコメントとして認識されてしまいます。
そのため、記事ページに移動してからでないとコメントが表示されないように修正が必要でした。</p>
</div>
<div class="listingblock">
<div class="title">node_modules/hexo-plugin-gitalk/index.js</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript"><pre><code class="highlight javascript">link:node_modules/hexo-plugin-gitalk/index.js[]</code></pre></code></pre>
</div>
</div>
<div class="paragraph">
<p>結局、細かいところを直しつつというのは変わらない気がしますが。。。</p>
</div>
</div>
</div>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2020/02/16/20200215-hexo/" data-id="cke4hlcu0000bndl244xc1lps" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AsciiDoc/" rel="tag">AsciiDoc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GitHub-Pages/" rel="tag">GitHub Pages</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pelican/" rel="tag">Pelican</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20190411-centos7-rsyslog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/11/20190411-centos7-rsyslog/" class="article-date">
  <time datetime="2019-04-10T15:00:00.000Z" itemprop="datePublished">2019-04-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/11/20190411-centos7-rsyslog/">CentOS7のrsyslogが大量にメモリを消費する問題</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1663267" target="_blank" rel="noopener" class="bare">https://bugzilla.redhat.com/show_bug.cgi?id=1663267</a></p>
</div>
<div class="paragraph">
<p>現在の CentOS7 最新版である rsyslog-8.24-0.34.el7 でメモリリーク問題が上がっています。
とあるLinuxサーバで、このバグを踏んで、同じように大量にメモリを消費して一時的にswap領域まで使用していました。</p>
</div>
<div class="paragraph">
<p>一時しのぎとして、rsyslog 公式リポジトリのバージョンを使うことで問題は解消されましたが、このままでは CentOS7 の rsyslog が使えないままなので、この問題を再現させる方法を調べました。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_再現方法">再現方法</h2>
<div class="sectionbody">
<div class="paragraph">
<p>単純に logger コマンドで /dev/log に書き出すのでは駄目で、<strong>長い文字列</strong> を <strong>可能な限り速く</strong> 書き続ける必要がありました。</p>
</div>
<div class="paragraph">
<p>以下のC言語のコードで再現しました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c"><pre><code class="highlight c"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;syslog.h&gt;</span></span>

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;
  openlog(<span class="string">"test"</span>, <span class="number">0</span>, LOG_USER);
  <span class="keyword">for</span>(;;)
    syslog(LOG_ERR, <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>
    <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>
    <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>
    <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>
    <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>
    <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>);
&#125;</code></pre></code></pre>
</div>
</div>
<div class="paragraph">
<p>早く修正されてほしい。</p>
</div>
</div>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2019/04/11/20190411-centos7-rsyslog/" data-id="cke4hlcue000kndl20xkq49xd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS-7/" rel="tag">CentOS 7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memory-leak/" rel="tag">memory leak</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rsyslog/" rel="tag">rsyslog</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20190410-portreserve" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/10/20190410-portreserve/" class="article-date">
  <time datetime="2019-04-09T15:00:00.000Z" itemprop="datePublished">2019-04-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/10/20190410-portreserve/">なぞのプロセス portreserve の調査</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="paragraph">
<p>とあるLinuxサーバのプロセスを確認したところ portreserve というプロセスが 631 ポートを開いていました。
portreserve は今まで聞いたことのないサービス名だったので調査したところ「ポートを予約するためのサービス」であるとのこと。</p>
</div>
<div class="paragraph">
<p>CentOS7 でもパッケージが存在していたので、インストールしてみて man で確認したところ</p>
</div>
<div class="listingblock">
<div class="title">/etc/portreserve/&lt;ファイル名&gt;</div>
<div class="content">
<pre>サービス名称( /etc/services に記載されている名前に限る )</pre>
</div>
</div>
<div class="paragraph">
<p>を設定すれば、予約ができるとありました。</p>
</div>
<div class="paragraph">
<p>実験として、telnet のポートを予約する場合は、</p>
</div>
<div class="listingblock">
<div class="title">/etc/portreserve/telnet</div>
<div class="content">
<pre>telnet</pre>
</div>
</div>
<div class="paragraph">
<p>と記載して portreserve を再起動すれば portreserve が 23番ポートを bind しました。</p>
</div>
<div class="paragraph">
<p>nc コマンドで LISTEN しようとしてもエラーになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># nc -l 0.0.0.0 23
Ncat: bind to 0.0.0.0:23: Address already in use. QUITTING.</pre>
</div>
</div>
<div class="paragraph">
<p>次に、このポートを解放する場合は、以下のように Datagram の UNIX-Domainソケットで /var/run/portreserve/socket に接続し、サービス名を送信します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># echo -n "telnet" | nc -u -U /var/run/portreserve/socket</pre>
</div>
</div>
<div class="paragraph">
<p>これで telnet で使用する 23番ポート は解放されるので、nc コマンドで LISTEN できるようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># nc -l 0.0.0.0 23</pre>
</div>
</div>
<div class="paragraph">
<p>以上が portreserve の使い方らしいのですが、使う場面が全くわかりませんでした。</p>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2019/04/10/20190410-portreserve/" data-id="cke4hlctx0009ndl26pbo0tr5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS-7/" rel="tag">CentOS 7</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20190401-nextcloud" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/01/20190401-nextcloud/" class="article-date">
  <time datetime="2019-03-31T15:00:00.000Z" itemprop="datePublished">2019-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/01/20190401-nextcloud/">docker+nextcloudで構築するときDBを初期化できないときの対処法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="paragraph">
<p>docker-compose で、nextcloud と postgresql を以下のように定義したが起動しなかった。</p>
</div>
<div class="listingblock">
<div class="title">docker-compose.yml</div>
<div class="content">
<pre>version: '3'
services:
  app:
    image: nextcloud:15.0.5
    ports:
      - 8080:80
    depends_on:
      - db
    volumes:
      - nextcloud:/var/www/html
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=secret
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=admin
    restart: always

  db:
    image: postgres:9.6
    restart: always
    volumes:
      - postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=secret

volumes:
  nextcloud:
    driver: local
  postgres:
    driver: local</pre>
</div>
</div>
<div class="paragraph">
<p>コンテナの出力には、以下のような permission denied for database となっているが、</p>
</div>
<div class="listingblock">
<div class="content">
<pre>db_1   | 2019-04-01 14:24:55.443 UTC [71] FATAL:  permission denied for database "nextcloud"
db_1   | 2019-04-01 14:24:55.443 UTC [71] DETAIL:  User does not have CONNECT privilege.</pre>
</div>
</div>
<div class="paragraph">
<p>postgres のコンテナに nextcloud というデータベースで postgres ユーザがスーパーユーザでアクセスできているように見える。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ docker-compose exec -it -u postgres db /bin/bash
$ psql nextcloud postgres
nextcloud=# \du
                                    List of roles
 Role name  |                         Attributes                         | Member of
------------+------------------------------------------------------------+-----------
 oc_admin   | Create DB                                                  | &#123;&#125;
 oc_admin10 | Create DB                                                  | &#123;&#125;
 oc_admin11 | Create DB                                                  | &#123;&#125;
 oc_admin12 | Create DB                                                  | &#123;&#125;
 oc_admin13 | Create DB                                                  | &#123;&#125;
 oc_admin14 | Create DB                                                  | &#123;&#125;
 oc_admin15 | Create DB                                                  | &#123;&#125;
 oc_admin16 | Create DB                                                  | &#123;&#125;
 oc_admin2  | Create DB                                                  | &#123;&#125;
 oc_admin3  | Create DB                                                  | &#123;&#125;
 oc_admin4  | Create DB                                                  | &#123;&#125;
 oc_admin5  | Create DB                                                  | &#123;&#125;
 oc_admin6  | Create DB                                                  | &#123;&#125;
 oc_admin7  | Create DB                                                  | &#123;&#125;
 oc_admin8  | Create DB                                                  | &#123;&#125;
 oc_admin9  | Create DB                                                  | &#123;&#125;
 postgres   | Superuser, Create role, Create DB, Replication, Bypass RLS | &#123;&#125;

nextcloud=# \q</pre>
</div>
</div>
<div class="paragraph">
<p>このデータベースを削除することで nextcloud 側で自動的にデータベースを作成してくれた。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ dropdb nextcloud postgres</pre>
</div>
</div>
<div class="paragraph">
<p>nextcloud のコンテナの動作が今後変わると修正されるかもしれない。</p>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2019/04/01/20190401-nextcloud/" data-id="cke4hlcu7000gndl2fk09cp63" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NextCloud/" rel="tag">NextCloud</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20190316-journald" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/16/20190316-journald/" class="article-date">
  <time datetime="2019-03-15T15:00:00.000Z" itemprop="datePublished">2019-03-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/16/20190316-journald/">journaldを経由せずにrsyslogから/dev/logを使う</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="sect1">
<h2 id="_背景">背景</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CentOS 7 で、とあるサーバを構築し、負荷試験を実施したところ systemd-journald がCPU100%使い切っており、本来のパフォーマンスが発揮されないことが判明しました。</p>
</div>
<div class="paragraph">
<p>レガシーの syslog() で秒間数万行以上の大量のログを出力しており、systemd-journald プロセスの処理が追いつかず /dev/log ソケットでメッセージが詰まってしまったことが原因でした。</p>
</div>
<div class="paragraph">
<p>根本的な原因は syslog() で大量のログを出力していることにあるのですが、systemd-journald も結局は rsyslog に転送してログファイルに書き出しているだけなので、ボトルネックになってほしくはありません。</p>
</div>
<div class="paragraph">
<p>systemd-journald が高負荷になった原因については、詳しくは調べていません。おそらくはメッセージの付属情報の取得やバイナリデータ用のデータベースへの書き込みなどの処理にあると思っています。</p>
</div>
<div class="paragraph">
<p>また、syslog() は、rsyslog でログファイルに書き込んでいます。そのため、systemd-journald のバイナリログと rsyslog のログファイルの両方に保存していることなるので systemd-journald を経由することは、はっきり言って無駄な処理となっています。</p>
</div>
<div class="paragraph">
<p>そのため、sytemd-journald を経由せずに直接 rsyslog で /dev/log を使う設定を調査しました。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_設定">設定</h2>
<div class="sectionbody">
<div class="paragraph">
<p>/dev/log は Datagram ベースの UNIX-domain socket です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># fuser -v /dev/log
                     USER        PID ACCESS COMMAND
/dev/log
                     root          1 F.... systemd
                     root       6277 F.... systemd-journal

# netstat -x | grep dev
unix  3      [ ]         DGRAM                    103043   /dev/log</pre>
</div>
</div>
<div class="paragraph">
<p>systemd-journald.socket ファイルの /dev/log をコメントアウトします。</p>
</div>
<div class="listingblock">
<div class="title">/usr/lib/systemd/system/systemd-journald.socket</div>
<div class="content">
<pre>[Socket]
ListenStream=/run/systemd/journal/stdout
ListenDatagram=/run/systemd/journal/socket
#ListenDatagram=/dev/log  #コメントアウト</pre>
</div>
</div>
<div class="paragraph">
<p>rsyslog の SystemLogSocketName を設定を変更します。</p>
</div>
<div class="listingblock">
<div class="title">/etc/rsyslog.d/listen.conf</div>
<div class="content">
<pre>#$SystemLogSocketName /run/systemd/journal/syslog  #コメントアウト
$SystemLogSocketName /dev/log                      #デフォルト値なので記述しなくてもいいのですが、書いたほうが分かりやすいと思います</pre>
</div>
</div>
<div class="paragraph">
<p>rsyslog の設定を変更します。</p>
</div>
<div class="listingblock">
<div class="title">/etc/rsyslog.conf</div>
<div class="content">
<pre>$ModLoad imuxsock                    #アンコメント
#$ModLoad imjournal                  #コメントアウト
$OmitLocalLogging off                #off に変更
#$IMJournalStateFile imjournal.state #コメントアウト

#$imjournalRatelimitInterval 0       #記述した場合はコメントアウト
#$imjournalRatelimitBurst 0          #記述した場合はコメントアウト</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>詳細 <a href="https://www.rsyslog.com/doc/v8-stable/configuration/modules/imuxsock.html" target="_blank" rel="noopener" class="bare">https://www.rsyslog.com/doc/v8-stable/configuration/modules/imuxsock.html</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>systemd-journald と rsyslogd の再起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># systemctl restart rsyslog
# systemctl status rsyslog
→status でエラーがないことを確認。

# systemctl restart systemd-journald
# systemctl status systemd-journald
→status でエラーがないことを確認。</pre>
</div>
</div>
<div class="paragraph">
<p>/dev/log を掴んでいるプロセスを確認します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># fuser -v /dev/log
                     USER        PID ACCESS COMMAND
/dev/log
                     root          1 F.... systemd
                     root       9218 F.... rsyslog
                     root       9234 F.... systemd-journal</pre>
</div>
</div>
<div class="paragraph">
<p>systemd-jounral が /dev/log を掴んだままであれば、OS再起動をします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre># reboot

... 再起動後...

# fuser -v /dev/log
                     USER        PID ACCESS COMMAND
/dev/log
                     root          1 F.... systemd
                     root        128 F.... rsyslog</pre>
</div>
</div>
<div class="paragraph">
<p>これで rsyslog で直接 /dev/log を取得できるようになりました。</p>
</div>
<div class="paragraph">
<p>sytemd-journald 自体のログ収集は止めていないため モダンな /run/systemd/journal/socket ソケットからのログは journalctl で検索可能です。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_補足">補足</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この方法は、おそらく CentOS 7 でしか利用できません。別のディストビューションの場合、/dev/log は /run/systemd/journal/dev-log のシンボリックリンクになっている場合があります。</p>
</div>
</div>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2019/03/16/20190316-journald/" data-id="cke4hlctu0008ndl21omn1jdy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CentOS-7/" rel="tag">CentOS 7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/journald/" rel="tag">journald</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rsyslog/" rel="tag">rsyslog</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20190218-ndsend" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/18/20190218-ndsend/" class="article-date">
  <time datetime="2019-02-17T15:00:00.000Z" itemprop="datePublished">2019-02-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/18/20190218-ndsend/">IPv6でGARPみたいなパケットを投げる</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="paragraph">
<p>以下のソースコードでICMPv6のNeighbor Advertisement の override flag を設定し、強制的にIPv6アドレスとMACアドレスの対応関係を誘導させることが可能.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://src.openvz.org/projects/OVZ/repos/vzctl/browse/src/ndsend.c" target="_blank" rel="noopener" class="bare">https://src.openvz.org/projects/OVZ/repos/vzctl/browse/src/ndsend.c</a></div>
<div class="content">
<pre class="highlight"><code class="language-c" data-lang="c"><pre><code class="highlight c"><span class="comment">/*</span>
<span class="comment"> * Copyright (c) 1999-2017, Parallels International GmbH</span>
<span class="comment"> *</span>
<span class="comment"> * This code is public domain.</span>
<span class="comment"> *</span>
<span class="comment"> * This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</span>
<span class="comment"> * WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="comment"> *</span>
<span class="comment"> * Our contact details: Parallels International GmbH, Vordergasse 59, 8200</span>
<span class="comment"> * Schaffhausen, Switzerland.</span>
<span class="comment"> */</span>

<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span>

<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/icmp6.h&gt;</span></span>

<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span>

<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;getopt.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span>
<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span>

<span class="meta">#<span class="meta-keyword">define</span> EXC_OK 0</span>
<span class="meta">#<span class="meta-keyword">define</span> EXC_USAGE	1</span>
<span class="meta">#<span class="meta-keyword">define</span> EXC_SYS		2</span>
<span class="meta">#<span class="meta-keyword">define</span> EXC_RECV	3</span>
<span class="meta">#<span class="meta-keyword">define</span> EXC_NORECV	4</span>

<span class="keyword">char</span>* iface = <span class="literal">NULL</span>;

<span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">src_ipaddr</span>;</span>
<span class="keyword">int</span> ifindex;
__u8 real_hwaddr[<span class="number">6</span>];

<span class="class"><span class="keyword">struct</span> <span class="title">nd_packet</span> &#123;</span>
	__u8		icmp6_type;
	__u8		icmp6_code;
	__u16		icmp6_cksum;

	__u32		reserved:<span class="number">5</span>,
			<span class="keyword">override</span>:<span class="number">1</span>,
			solicited:<span class="number">1</span>,
			router:<span class="number">1</span>,
			reserved2:<span class="number">24</span>;
	<span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">target</span>;</span>
	__u8		otype;
	__u8		ospace;
	__u8		obits[<span class="number">6</span>];
&#125;;

<span class="function"><span class="keyword">int</span> <span class="title">init_device_addresses</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">const</span> <span class="keyword">char</span>* device)</span></span>
<span class="function"></span>&#123;
	<span class="class"><span class="keyword">struct</span> <span class="title">ifreq</span> <span class="title">ifr</span>;</span>

	<span class="built_in">memset</span>(&amp;ifr, <span class="number">0</span>, <span class="keyword">sizeof</span>(ifr));
	<span class="built_in">strncpy</span>(ifr.ifr_name, device, IFNAMSIZ<span class="number">-1</span>);

	<span class="keyword">if</span> (ioctl(sock, SIOCGIFINDEX, &amp;ifr) != <span class="number">0</span>) &#123;
		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unknown network interface %s: %m\n"</span>, device);
		<span class="keyword">return</span> <span class="number">-1</span>;
	&#125;
	ifindex = ifr.ifr_ifindex;

	<span class="comment">/* get interface HW address */</span>
	<span class="keyword">if</span> (ioctl(sock, SIOCGIFHWADDR, &amp;ifr) != <span class="number">0</span>) &#123;
		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Cannot get the MAC address of "</span>
				<span class="string">"network interface %s: %m\n"</span>, device);
		<span class="keyword">return</span> <span class="number">-1</span>;
	&#125;
	<span class="built_in">memcpy</span>(real_hwaddr, ifr.ifr_hwaddr.sa_data, <span class="number">6</span>);

	<span class="keyword">return</span> <span class="number">0</span>;
&#125;

<span class="keyword">int</span> sock;
<span class="class"><span class="keyword">struct</span> <span class="title">nd_packet</span> <span class="title">pkt</span>;</span>

<span class="function"><span class="keyword">void</span> <span class="title">create_nd_packet</span><span class="params">(struct nd_packet* pkt)</span></span>
<span class="function"></span>&#123;
	pkt-&gt;icmp6_type = ND_NEIGHBOR_ADVERT;
	pkt-&gt;icmp6_code = <span class="number">0</span>;
	pkt-&gt;icmp6_cksum = <span class="number">0</span>;
	pkt-&gt;reserved = <span class="number">0</span>;
	pkt-&gt;<span class="keyword">override</span> = <span class="number">1</span>;
	pkt-&gt;solicited = <span class="number">0</span>;
	pkt-&gt;router = <span class="number">0</span>;
	pkt-&gt;reserved2 = <span class="number">0</span>;
	<span class="built_in">memcpy</span>(&amp;pkt-&gt;target, &amp;src_ipaddr, <span class="number">16</span>);
	pkt-&gt;otype = ND_OPT_TARGET_LINKADDR;
	pkt-&gt;ospace = <span class="number">1</span>;
	<span class="built_in">memcpy</span>(&amp;pkt-&gt;obits, real_hwaddr, <span class="number">6</span>);
&#125;

<span class="function"><span class="keyword">void</span> <span class="title">sender</span><span class="params">(<span class="keyword">void</span>)</span></span>
<span class="function"></span>&#123;
	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span> <span class="title">to</span>;</span>

	to.sin6_family = AF_INET6;
	to.sin6_port = <span class="number">0</span>;
	((__u32*)&amp;to.sin6_addr)[<span class="number">0</span>] = htonl(<span class="number">0xFF020000</span>);
	((__u32*)&amp;to.sin6_addr)[<span class="number">1</span>] = <span class="number">0</span>;
	((__u32*)&amp;to.sin6_addr)[<span class="number">2</span>] = <span class="number">0</span>;
	((__u32*)&amp;to.sin6_addr)[<span class="number">3</span>] = htonl(<span class="number">0x1</span>);
	to.sin6_scope_id = ifindex;

	<span class="keyword">if</span> (sendto(sock, &amp;pkt, <span class="keyword">sizeof</span>(pkt), <span class="number">0</span>,
	    (struct sockaddr*) &amp;to, <span class="keyword">sizeof</span>(to)) &lt; <span class="number">0</span>) &#123;
		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"sendto function returned error: %m\n"</span>);
		<span class="built_in">exit</span>(EXC_SYS);
	&#125;
&#125;

<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span>** argv)</span></span>
<span class="function"></span>&#123;
	<span class="keyword">int</span> value;

	<span class="keyword">if</span> (inet_pton(AF_INET6, argv[<span class="number">1</span>], &amp;src_ipaddr) &lt;= <span class="number">0</span>)
		<span class="keyword">return</span> <span class="number">-1</span>;
	iface = argv[<span class="number">2</span>];

	sock = socket(PF_INET6, SOCK_RAW, IPPROTO_ICMPV6);
	<span class="keyword">if</span> (sock &lt; <span class="number">0</span>) &#123;
		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"socket function returned error: %m\n"</span>);
		<span class="built_in">exit</span>(EXC_SYS);
	&#125;

	<span class="keyword">if</span> (init_device_addresses(sock, iface) &lt; <span class="number">0</span>)
		<span class="built_in">exit</span>(EXC_SYS);

	value = <span class="number">255</span>;
	setsockopt (sock, SOL_IPV6, IPV6_MULTICAST_HOPS,
		    &amp;value, <span class="keyword">sizeof</span> (value));

	create_nd_packet(&amp;pkt);
	sender();
	<span class="built_in">exit</span>(EXC_OK);
&#125;</code></pre></code></pre>
</div>
</div>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"552cbd212e71c5d6c3e0","clientSecret":"4402dc0c5c3a368fca4f5ecfe4fa69290a429207","repo":"harre-orz.github.io","owner":"harre-orz","admin":["harre-orz"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://harre-orz.github.io/2019/02/18/20190218-ndsend/" data-id="cke4hlctr0005ndl2dmau57is" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GARP/" rel="tag">GARP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ICMPv6/" rel="tag">ICMPv6</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IPv6/" rel="tag">IPv6</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/" rel="tag">Ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AsciiDoc/" rel="tag">AsciiDoc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOS-6/" rel="tag">CentOS 6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOS-7/" rel="tag">CentOS 7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GARP/" rel="tag">GARP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub-Pages/" rel="tag">GitHub Pages</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ICMPv6/" rel="tag">ICMPv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPv6/" rel="tag">IPv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LVM/" rel="tag">LVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LXC/" rel="tag">LXC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NextCloud/" rel="tag">NextCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenVAS/" rel="tag">OpenVAS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pelican/" rel="tag">Pelican</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/journald/" rel="tag">journald</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-leak/" rel="tag">memory leak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsync/" rel="tag">rsync</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsyslog/" rel="tag">rsyslog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Ansible/" style="font-size: 10px;">Ansible</a> <a href="/tags/AsciiDoc/" style="font-size: 16.67px;">AsciiDoc</a> <a href="/tags/CentOS-6/" style="font-size: 10px;">CentOS 6</a> <a href="/tags/CentOS-7/" style="font-size: 20px;">CentOS 7</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/GARP/" style="font-size: 10px;">GARP</a> <a href="/tags/GitHub-Pages/" style="font-size: 13.33px;">GitHub Pages</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/ICMPv6/" style="font-size: 10px;">ICMPv6</a> <a href="/tags/IPv6/" style="font-size: 10px;">IPv6</a> <a href="/tags/LVM/" style="font-size: 10px;">LVM</a> <a href="/tags/LXC/" style="font-size: 10px;">LXC</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/NextCloud/" style="font-size: 10px;">NextCloud</a> <a href="/tags/OpenVAS/" style="font-size: 10px;">OpenVAS</a> <a href="/tags/Pelican/" style="font-size: 16.67px;">Pelican</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/journald/" style="font-size: 10px;">journald</a> <a href="/tags/memory-leak/" style="font-size: 10px;">memory leak</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/rsyslog/" style="font-size: 13.33px;">rsyslog</a> <a href="/tags/ssh/" style="font-size: 13.33px;">ssh</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/08/22/20200822-sshpiper/">SSHをプロキシするsshpiperの紹介</a>
          </li>
        
          <li>
            <a href="/2020/02/22/20200222-lxc-centos/">CentOS7のLXCでCentOS6を非特権ユーザで起動させる</a>
          </li>
        
          <li>
            <a href="/2020/02/21/20200221-lvm-mysql/">MySQLのデータベースごとにディスク容量制限を簡単にしたい</a>
          </li>
        
          <li>
            <a href="/2020/02/18/20200218-rsync/">大量のデータをrsyncで転送できない問題とその解決策</a>
          </li>
        
          <li>
            <a href="/2020/02/16/20200215-hexo/">静的サイトジェネレータをPelicanからHexoに切り替えた</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
<script data-ad-client="ca-pub-3360456910575678" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>.<br />
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>